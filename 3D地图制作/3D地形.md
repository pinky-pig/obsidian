
> <https://github.com/joewdavies/geoblender/tree/master>
> 
> <https://mp.weixin.qq.com/mp/homepage?__biz=Mzk0MzE3MTM1OA==&hid=3&sn=ef1daea6970327be5a3f7630ff915cb2&scene=18&uin=&key=&devicetype=Windows+10+x64&version=6309071d&lang=zh_CN&ascene=15&session_us=gh_a79fc896f6cb>
> 
> 结合 QGIS 和 Blender 制作 3D 地图，首先需要简单理解几个概念。
> 1. Blender 处理的是 3D 模型
> 2. 高程数据通常是以栅格形式存在的
> 
> 3D地形就是高程图根据高度差的颜色不同，作为材质贴图上去。
> 3D模型地图是设置其纹理属性。

## **步骤**

- **获取高程数据：** 使用公开数据
- **选择区域和分辨率：** 在获取高程数据时，选择你感兴趣的地理区域以及适当的分辨率。较高的分辨率将提供更详细的地形信息，但可能需要更多的存储和处理资源。
- **数据格式转换：** 大多数高程数据以栅格格式存在，如GeoTIFF、DEM等。需要将数据转换为Blender能够理解的格式，通常是高程地形的3D模型。
- **导入Blender：** 一旦获得了3D模型的高程数据，可以将其导入Blender。你可以使用Blender的导入工具，通常支持多种3D模型格式，如STL、OBJ等。导入后，高程数据将成为Blender中的3D对象。
- **调整和渲染：** 在Blender中，可以对导入的高程数据进行调整、编辑和渲染。可以为其添加纹理、颜色，也可以进行地形细节的编辑和渲染设置。
- **光照和摄影机设置：** 为了获得逼真的渲染效果，还可以设置光照和摄影机视角，以便呈现出高程数据的立体感和质感。
- **渲染和输出：** 最后，可以使用Blender的渲染引擎来呈现高程数据，并将渲染结果导出为图像或视频文件，以便在其他项目中使用。


## **渲染流程**


### QGIS 处理数据

- **下载高程：** <https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/elevation/copernicus-dem/elevation>
- **导入 QGIS ：** 直接拖拽进来就行了。这里 ttf 文件 。
- **合并 ：** 下载的高程数据都是一方块一方块的，所以可能跟期待的地区不一致，需要修改。
- - **1.** 这里执行合并操作，上面下载了两个高程数据，然后直接拖拽进 QGIS ，会在左侧图层面板看到有两个图层。
- - **2.** 因为高程地理数据是有空间信息的，所以两个高程数据自然会按真实的拼接在一起（下载的地图上在哪就在哪位置）
- - **3.** 开始合并！找到 QGIS 最上面操作栏的“栅格（Raster）”，因为高程数据就是以栅格存在的，所以这里操作高程数据最理所当然，然后往下面找到“合并（merge）”，可能二级目录没有，那就在三级目录下。点击合并后，会出来弹窗，然后在“参数” Tab 下找到“输入图层”，然后选择要合并的那两个图层，再点击“运行”，然后就静等合并完成，会看到图层面板新增一个图层，就是合并后的图层了。
- - **3.1** 快捷键操作：点击上面的“数据梳理”，点开工具箱（Ctrl+ALt+T），然后右侧会有工具箱面板，在搜索栏输入“merge”，就筛选到合并了，双击运行同上步骤。
- **裁剪 ：** 自然还是找到“栅格” -> “提取” -> "按范围提取" 。图层选择刚才合并过的，裁剪范围选择最右边的下拉框，点击找到“在地图画布中绘制”，然后就能绘制所要裁剪的范围了。直接运行，静等裁剪完成，同样会新增一个裁剪后的图层。
- **重投影 ：** 这一步骤就是为了让效果更好，但是还是要自己观察哪种效果更好。这里在“栅格” -> “投影” -> "变形（重投影）"，在弹窗中设置“要使用的重采样方法”为 "Lanczos Windowed Sinc"，点击运行就好了。快捷方式是工具箱面板筛选“Wrap”。
- **拉伸 ：** 高程数据，就是地面高度，从底部到天空，一般情况下是0到4000左右。因为我们要最终导入到 Blender ，要在 Blender 中能够看的清楚地势差，而一般范围太大，地势差不明显，是平坦的。所以我们要拉伸，在视觉上看的出来，满足视觉效果，当然这跟实际不一致了，但是要看的是地势差对比，所以应该还是影响不大。而且两个软件的精度不一致，高程是小数，Blender是整数，从 QGIS 导出然后导入到 Blender 中，小数自然会被舍去，数据丢失，那么模型细节就会缺失。但是要拉伸，那么就需要拉伸公式，这里抄一个 `(像素值-最低值)/(最高值-最低值)*65535` ，这里QGIS是 `("mountain@1"-42)/(2283-42)*65535` 。那么找到“栅格”->“栅格计算器” （快捷方式是在工具箱面板输入 `Raster Calculator`），然后输入公式运行。
- **转换像素类型 ：** 在“合并（merge）”的时候，设置“输出数据类型”为“UInt16”


### Blender 处理模型

- **切换引擎 ：** 右侧工具栏 `scene` 更改，使用 Cycles 渲染引擎，并开启试验特性。（目的用一些厉害的新功能，不换效果出不来）
- **初始化模型：** 找到要到 tif 文件，右键属性，查看分辨率。在 blender 工程中，删除默认的立方体，添加一个平面，在右侧设置平面的缩放 x  y 值跟 tif 的分辨率保持一致。为了让模型场景跟要渲染的高程数据尺寸一样大。这个添加的平面就是等会要渲染的模型。
- **添加材质：** 上面一步已经设置好一个平面模型作为3D模型的载体，下面就是要将高程数据作为材质给模型。选中“平面”，然后在右侧工具栏找到“材质属性”，创建一个材质。这样就简单创建好了。

以上就是最最基本的操作了，新建的平面（plane） 就是最终要渲染的，不过要将下面处理的材质贴图上去，才能显示的更好看。

-  **着色器编辑器：** 左键选中平面（plane），找到右侧工具栏的材质（Material） -> 新建。然后这里就添加了一个材质，下面就是需要两步，1.将高程图作用于这个材质，2.将这个材质作用到平面（plane）。这里就是通过蓝图编辑了，左上角切换“3D视图”到“着色器编辑器”，因为刚才已经添加了材质，所以蓝图中会有两个卡片，一个是“原理化”一个是“材质输出”。
- **图像纹理：**  从蓝图上看连线，增加的材质已经作用到平面了。而要想高程图作用于材质，那么需要添加一个“图像纹理”，“Shift+A” -> “纹理” -> “图像纹理” ，然后在新加到蓝图上的“图像纹理”卡片点击“打开”，在文件夹中选择高程图文件。然后将“图像纹理”卡片右边黄色触点“颜色”连接到“材质输出”卡片左侧的“置换”触点。以上就完成了基础流程，可以按F12渲染了。

综上，其实主流程思路很简单：
1. 设置 Blender 的渲染引擎为 Cycles ，并启用试验特性。
2. 将高程图作为图像纹理，置换到材质，作用到平面。

接下来就是优化渲染图，包括从表面细分、调整变形，然后相机、灯光、颜色、

- **置换：** 上面已经将材质作用到平面了，接下来就是将凹凸面置换成真正的立体模型。“Shift+A” -> “矢量” -> “置换”，因为是输入高程图，输出为置换出来立体的模型，然后再作为输入给材质。所以连线也很清晰，高程“图像纹理”卡片的右侧输出连接“置换”左侧的高度，然后再“置换卡片”右侧的触点“置换”连接“材质输出”卡片的左侧“置换”。这样就作用成功了，但是要想材质真正到自己期望的效果，还需要设置材质，右侧工具箱面板“材质属性” -> “设置” -> "表面" -> "置换" ，设置为 “置换与凹凸”。
- **优化变形：** 从平面材质到立体图形就是通过"置换"，所以如果形变比较夸张，那么就是修改置换的缩放。然后修改高程图的图像纹理的时候，也可以将“图像纹理”中的“重复”改为“扩展”。这样效果可能会好一点。

- **相机：** 相机就是你的眼睛，相机在哪就看到啥，最终效果就是什么。这里我先设置位置在正上方，Z轴。按住小键盘 “0 键”，进入相机视角，中间较亮部分是我们的效果渲染出图区域（相机捕获区域）。然后设置大小，回忆三个概念：**高程图的大小**，**平面模型的大小**、**相机的大小**。高程图和平面模型的大小保持一致最基础的，当然不一致就是渲染效果不好。相机的大小因为有距离远近，尺寸大小概念，在 Blender 中看有啥不同，也比较好自我理解。
- **光源：** 也是修改位置及角度以及灯光强度之类的，自己把握。
- **渲染精度：** 这里受到影响的点有多个，比如原始高程图的精度，从 QGIS 处理后高程图的精度，在 Blender 渲染输出时候的精度等。这里直接在 Blender 的右侧工具栏“渲染属性” -> “采样” ，然后将渲染的精度调高些。
- **颜色：** 高程度本来就是描述高度的图，从低到高，所以表现高度的方式就是渐变色。这里就是自定义一种渐变色。“Shift+A” -> “转化器” -> “颜色渐变” ，然后在卡片中自己更改了。增加的高程“图像纹理”的右边黄色“颜色”触点连接到“颜色渐变”的系数，因为颜色渐变颜色定义了，而其输入就是高程，从低到高。输出则是颜色，要作用到平面，所以“颜色渐变”卡片右侧的输出黄色触点“颜色”连接“原理化”卡片的左侧黄色触点基础色。



### Blender 简单3D模型

上面的方法可以更加精细地调整设置模型，但是有个缺点就是比较繁琐，这里有个更简单的方式，看起来也更加直观，可以直接点击第三个链接查看教程。

[Klas Karlsson](https://www.youtube.com/watch?v=AJJNX243k9E&t=1479s)
[GIS Solutions](https://www.youtube.com/watch?v=J8wkghNmsWc&t=57s)
[GIS 荟](https://mp.weixin.qq.com/s/sNF9nl_F6lPcDaSvKJYQCA)

这里其实主要就是使用到 Blender 的置换功能，流程更加简单，但是模型也更加粗糙。数据来源是 openstreetmap 和其他。

- **QGIS 插件：** openstreetmap 直接在插件管理中下载安装就行。然后图层中就能看到多出来的openstreetmap图层。
- **导出数据：** 在 QGIS 中导入 [Elevation](https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/elevation/copernicus-dem/elevation)下载的数据后，openstreetmap自然也是会叠加到那个位置的。分别导出原来的 dem 数据图片和 osm 的数据图片，使用 dem 的数据是为了渲染出3D模型，使用 osm 的数据图片是为了作为材质叠加到3D模型表面，更加好看。`Project` -> `Import/Export` ->`Export Map to Image`
- **细分：** 这里跟上面一样，新建平面（Plane）后，最重要的一步**细分**，`编辑模式` -> `右上角 Overlays` -> `统计信息` 打开。然后将平面模型选中后，右键细分，这里数值越大，模型越精细，我这里弄个4万多试试。
- **置换：** 找到工具箱的小扳手，`添加修改器`->`置换`->`新建` 。找到`纹理`->`打开` -> `选中高程图`。这样就会在对象模式的主视图中看到高程图的3D模型了。当然可能模型的大小有点夸张，找到小扳手中，刚才添加的修改器置换